<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Face Oyunu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js kütüphanesini yüklüyoruz -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Tone.js kütüphanesini ses için yüklüyoruz -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #0f172a;
            color: #f8fafc;
        }
        canvas {
            background-color: #87CEEB; /* Sabit arka plan rengi */
            background-size: cover;
            background-position: center;
            display: block;
            margin: 0 auto;
            border-radius: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 90%;
            width: 500px;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-4xl md:text-5xl mb-4 text-center">Flappy Face</h1>
    <p class="mb-4 text-center">Kendi yüzünle oyna!</p>

    <div id="game-container" class="w-full max-w-2xl mx-auto">
        <canvas id="gameCanvas" width="800" height="600" class="w-full h-auto"></canvas>
        <div id="score" class="text-center text-3xl mt-4">Skor: 0</div>
    </div>
    
    <div id="controls" class="mt-6 flex flex-col sm:flex-row items-center justify-center flex-wrap gap-4">
        <div class="flex flex-col items-center">
            <label for="imageUpload" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg cursor-pointer">
                1. Fotoğraf Yükle
            </label>
            <input type="file" id="imageUpload" class="hidden" accept="image/*">
            <img id="facePreview" class="mt-4 rounded-full border-4 border-blue-400 w-24 h-24 object-cover hidden" alt="Yüz Önizlemesi">
        </div>
        <button id="startGameBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg" disabled>
            2. Oyunu Başlat
        </button>
    </div>

    <!-- Modals -->
    <div id="loadingModal" class="modal hidden">
        <div class="modal-content">
            <p id="loadingText">Yükleniyor...</p>
            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500 mx-auto mt-4"></div>
        </div>
    </div>

    <div id="gameOverModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-4xl text-red-500 mb-4">Oyun Bitti!</h2>
            <p id="finalScore" class="text-2xl mb-6">Skorun: 0</p>
            <button id="restartBtn" class="btn bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-3 px-6 rounded-lg">
                Yeniden Başla
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const imageUpload = document.getElementById('imageUpload');
        const startGameBtn = document.getElementById('startGameBtn');
        const restartBtn = document.getElementById('restartBtn');
        const facePreview = document.getElementById('facePreview');
        const loadingModal = document.getElementById('loadingModal');
        const loadingText = document.getElementById('loadingText');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreDisplay = document.getElementById('finalScore');

        // Game Variables
        let player, pipes, score, gameState, animationFrameId;
        const gravity = 0.5;
        const jump = -8;
        const pipeWidth = 80;
        const pipeGap = 200;
        const pipeSpeed = 4;
        const pipeInterval = 120;
        let frameCount = 0;
        
        let playerImage = new Image();
        playerImage.src = 'https://placehold.co/60x60/FBBF24/000000?text=YUZ'; 

        const GAME_STATES = { MENU: 'menu', READY: 'ready', PLAYING: 'playing', GAME_OVER: 'game_over' };

        // Audio Variables
        let scoreSound, gameOverSound;
        let isAudioSetup = false;

        // Sesleri Ayarlama Fonksiyonu
        function setupAudio() {
            scoreSound = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
            }).toDestination();

            gameOverSound = new Tone.Synth({
                oscillator: { type: 'fatsquare' },
                envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.4 }
            }).toDestination();
        }

        // Face Detection
        async function loadFaceApiModels() {
            loadingModal.style.display = 'flex';
            loadingText.textContent = 'Yüz tanıma modelleri yükleniyor...'
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                console.log("Modeller yüklendi.");
                loadingModal.style.display = 'none';
            } catch (error) {
                console.error("Modeller yüklenirken hata oluştu:", error);
                loadingText.textContent = 'Modeller yüklenemedi. Sayfayı yenileyin.';
            }
        }
        
        // Game Logic
        class Player {
            constructor() {
                this.x = 150;
                this.y = canvas.height / 2;
                this.width = 60;
                this.height = 60;
                this.velocityY = 0;
            }

            draw() {
                ctx.save();
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, this.width / 2, 0, Math.PI * 2, true);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(playerImage, this.x, this.y, this.width, this.height);
                ctx.restore();
            }

            update() {
                this.velocityY += gravity;
                this.y += this.velocityY;

                if (this.y + this.height > canvas.height || this.y < 0) {
                    endGame();
                }
            }

            jump() {
                this.velocityY = jump;
            }
        }

        class Pipe {
            constructor() {
                this.x = canvas.width;
                this.width = pipeWidth;
                this.height = Math.random() * (canvas.height - pipeGap - 100) + 50;
                this.passed = false;
            }

            draw() {
                ctx.fillStyle = '#22c55e';
                ctx.fillRect(this.x, 0, this.width, this.height);
                const lowerPipeY = this.height + pipeGap;
                ctx.fillRect(this.x, lowerPipeY, this.width, canvas.height - lowerPipeY);

                ctx.fillStyle = '#16a34a';
                ctx.fillRect(this.x - 5, this.height - 20, this.width + 10, 20);
                ctx.fillRect(this.x - 5, this.height + pipeGap, this.width + 10, 20);
            }

            update() {
                this.x -= pipeSpeed;
            }
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            pipes.forEach(pipe => pipe.draw());
            player.draw();

            if (gameState === GAME_STATES.PLAYING) {
                player.update();
                frameCount++;
                if (frameCount % pipeInterval === 0) {
                    pipes.push(new Pipe());
                }
                
                for (let i = pipes.length - 1; i >= 0; i--) {
                    pipes[i].update();
                    if (pipes[i].x + pipeWidth < 0) {
                        pipes.splice(i, 1);
                    }
                    if (pipes[i].x + pipeWidth < player.x && !pipes[i].passed) {
                        score++;
                        scoreDisplay.textContent = `Skor: ${score}`;
                        pipes[i].passed = true;
                        // Skor sesi
                        if (scoreSound) {
                            scoreSound.triggerAttackRelease("C5", "8n");
                        }
                    }
                    if (checkCollision(player, pipes[i])) {
                        endGame();
                        return;
                    }
                }
            } else if (gameState === GAME_STATES.READY) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.font = "30px 'Press Start 2P'";
                ctx.fillStyle = "#FFFFFF";
                ctx.textAlign = "center";
                ctx.fillText("Başlamak için Tıkla", canvas.width / 2, canvas.height / 2 - 20);
                ctx.fillText("veya Boşluk Tuşuna Bas", canvas.width / 2, canvas.height / 2 + 20);
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }
        
        function checkCollision(player, pipe) {
            const playerCenterX = player.x + player.width / 2;
            const playerCenterY = player.y + player.height / 2;
            const playerRadius = player.width / 2;

            if (playerCenterX + playerRadius > pipe.x && playerCenterX - playerRadius < pipe.x + pipe.width) {
                if (playerCenterY - playerRadius < pipe.height || playerCenterY + playerRadius > pipe.height + pipeGap) {
                    return true;
                }
            }
            return false;
        }

        function startGame() {
            gameState = GAME_STATES.READY;
            player = new Player();
            pipes = [];
            score = 0;
            frameCount = 0;
            scoreDisplay.textContent = 'Skor: 0';
            gameOverModal.style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            scoreDisplay.style.display = 'block';
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
        }

        function endGame() {
            if (gameState === GAME_STATES.GAME_OVER) return;
            gameState = GAME_STATES.GAME_OVER;
            // Oyun bitme sesi
            if (gameOverSound) {
                gameOverSound.triggerAttackRelease("C3", "4n");
            }
            cancelAnimationFrame(animationFrameId);
            finalScoreDisplay.textContent = `Skorun: ${score}`;
            gameOverModal.style.display = 'flex';
        }

        function resetGame() {
            gameState = GAME_STATES.MENU;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            scoreDisplay.style.display = 'block';
            scoreDisplay.textContent = 'Skor: 0';
            document.getElementById('controls').style.display = 'flex';
            gameOverModal.style.display = 'none';

            ctx.font = "24px 'Press Start 2P'";
            ctx.fillStyle = "#1e293b";
            ctx.textAlign = "center";
            ctx.fillText("Oynamak için yüzünü yükle!", canvas.width / 2, canvas.height / 2);
        }
        
        function handleUserAction() {
            // Tarayıcıların sesleri otomatik başlatmasını engellemek için kullanıcı etkileşimiyle sesleri kuruyoruz.
            if (!isAudioSetup) {
                Tone.start();
                setupAudio();
                isAudioSetup = true;
                console.log("Sesler hazır.");
            }

            if (gameState === GAME_STATES.READY) {
                gameState = GAME_STATES.PLAYING;
                player.jump();
            } else if (gameState === GAME_STATES.PLAYING) {
                player.jump();
            }
        }

        // Event Listeners
        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            loadingModal.style.display = 'flex';
            loadingText.textContent = 'Yüz algılanıyor...';

            const img = new Image();
            img.src = URL.createObjectURL(file);
            
            img.onload = async () => {
                const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions());
                if (detection) {
                    const { x, y, width, height } = detection.box;
                    const faceCanvas = document.createElement('canvas');
                    const faceCtx = faceCanvas.getContext('2d');
                    
                    const padding = width * 0.4;
                    const cropX = Math.max(0, x - padding);
                    const cropY = Math.max(0, y - padding);
                    const cropWidth = width + padding * 2;
                    const cropHeight = height + padding * 2;
                    faceCanvas.width = cropWidth;
                    faceCanvas.height = cropHeight;
                    faceCtx.drawImage(img, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                    
                    playerImage.src = faceCanvas.toDataURL('image/png');
                    facePreview.src = playerImage.src;
                    facePreview.style.display = 'block';
                    
                    startGameBtn.disabled = false;
                    loadingModal.style.display = 'none';
                } else {
                    loadingText.textContent = 'Yüz bulunamadı! Başka bir fotoğraf deneyin.';
                    setTimeout(() => { loadingModal.style.display = 'none'; }, 2000);
                }
            };
        });

        startGameBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', resetGame);
        
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                 e.preventDefault();
                 handleUserAction();
            }
        });

        canvas.addEventListener('click', handleUserAction);

        // Initialization
        window.onload = () => {
            loadFaceApiModels();
            resetGame();
        };

    </script>
</body>
</html>
